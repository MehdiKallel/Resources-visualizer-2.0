<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <style media="screen" type="text/css"></style>
  <title>Masterthesis visualization</title>
  <script type="text/javascript" src="https://cpee.org/js_libs/jquery.min.js"></script>
  <script type="text/javascript" src="https://cpee.org/js_libs/jquery.browser.js"></script>
  <script type="text/javascript" src="https://cpee.org/js_libs/jquery.svg.min.js"></script>
  <script type="text/javascript" src="https://cpee.org/js_libs/jquery.svgdom.min.js"></script>
  <script type="text/javascript" src="https://cpee.org/js_libs/vkbeautify.js"></script>
  <script type="text/javascript" src="https://cpee.org/js_libs/util.js"></script>
  <script type="text/javascript" src="https://cpee.org/js_libs/printf.js"></script>
  <script type="text/javascript" src="https://cpee.org/js_libs/strftime.min.js"></script>
  <script type="text/javascript" src="https://cpee.org/js_libs/parsequery.js"></script>
  <script type="text/javascript" src="https://cpee.org/js_libs/underscore.min.js"></script>
  <script type="text/javascript" src="https://cpee.org/js_libs/jquery.caret.min.js"></script>
  <script type="text/javascript" src="https://cpee.org/js_libs/jquery.cookie.js"></script>
  <script type="text/javascript" src="https://cpee.org/js_libs/uidash.js"></script>
  <link rel="stylesheet" href="https://cpee.org/js_libs/uidash.css" type="text/css" />
  <link rel="stylesheet" href="https://cpee.org/js_libs/ui.css" type="text/css" />
  <script type="text/javascript" src="lib/html.js"></script>
  <script type="text/javascript" src="lib/svg.js"></script>
  <script type="text/javascript" src="lib/node.js"></script>
  <script type="text/javascript" src="lib/skill.js"></script>
  <script type="text/javascript" src="lib/subject.js"></script>
  <script type="text/javascript" src="lib/utils.js"></script>
  <script type="text/javascript" src="lib/worker.js"></script>
  <script type="text/javascript" src="lib/relation.js"></script>
  <script type="text/javascript" src="features-scripts/myUtils.js"></script>
  <script type="text/javascript" src="features-scripts/skillsFeature.js"></script>
  <script type="text/javascript" src="features-scripts/expressionBuilder.js"></script>
  <script type="text/javascript" src="features-scripts/worker.js"></script>
  <script type="text/javascript" src="form-handlers/formHandler.js"></script>
  <script type="text/javascript" src="orbitflower.js"></script>
  <script type="text/javascript" src="helpers/orbitScript.js"></script>
  <script type="text/javascript" src="features-scripts/zooming.js"></script>
  <link rel="stylesheet" href="helpers/custom.css" type="text/css" />
  <link rel="stylesheet" href="styles/dropdown.css" type="text/css" />
  <link rel="stylesheet" href="styles/gauge.css" type="text/css" />

  <link rel="stylesheet" href="styles/orbitflower-styles.css" type="text/css" />
  <script type="text/javascript">
    var filter = "";
    var viz;
    var serverlocation;
    var currentorgmodel;

    var skillsFeature;
    var parentNodeType;
    var relatedText;
    let activeSkillSegments = {};

    function getAllRelatedSkills(skillId) {
      const skills = new Set();
      const visited = new Set();

      function traverse(currentSkillId) {
        if (visited.has(currentSkillId)) return;
        visited.add(currentSkillId);
        skills.add(currentSkillId);

        $(
          `skill[id="${currentSkillId}"] relation[type="Parent"]`,
          currentorgmodel
        ).each(function () {
          const parentId = $(this).attr("id");
          if (parentId && !visited.has(parentId)) {
            traverse(parentId);
          }
        });

        $(
          `skill relation[type="Child"][id="${currentSkillId}"]`,
          currentorgmodel
        ).each(function () {
          const parentSkillId = $(this).closest("skill").attr("id");
          if (parentSkillId && !visited.has(parentSkillId)) {
            traverse(parentSkillId);
          }
        });
      }

      traverse(skillId);

      return Array.from(skills);
    }

    function getSkills(who) {
      let skills = $(
        "subject[uid=" + who + "] subjectSkills ref",
        currentorgmodel
      );
    }

    function getSkillsFromSkillAndEntity(skill, entity) {
      let skills = $("skill[uid=" + skill + "] ref", currentorgmodel);
      let entitySkills = $(
        "subject[uid=" + entity + "] subjectSkills ref",
        currentorgmodel
      );
    }

    function fillSkillsContainer(dataModel = null, isFiltered = false, orbitFlowerInstance = null) {
      const sourceModel = dataModel || currentorgmodel;
      let skills = $("skill", currentorgmodel); // Always get skills from full model for hierarchy
      let skillsContainer = $("#details-skills");
      skillsContainer.empty();

      // Calculate total subjects count from the source model
      const totalSubjects = $("subject", sourceModel).length;

      // Get referenced skills from the source model (for filtering logic)
      const referencedSkillIds = new Set();
      if (isFiltered) {
        $(sourceModel).find("subject subjectSkills ref").each(function() {
          const skillId = $(this).attr("id");
          if (skillId) {
            referencedSkillIds.add(skillId);
          }
        });
      }

      const allSkillsBtn = $(`
          <div id="all-skills-btn" class="skill-item" style="
            margin-left: 0px;
            border-left: 3px solid #4CAF50;
            padding: 5px;
            padding-right: 50px;
            cursor: pointer;
            font-weight: bold;
            background-color: #f5f5f5;">
            <span>${isFiltered ? 'All Skills (Filtered)' : 'All'}</span>
            <span class="subject-count" style="
              font-size: 11px;
              color: #666;
              background: #e0e0e0;
              padding: 2px 6px;
              border-radius: 10px;
              min-width: 20px;
              text-align: center;
              font-weight: 500;
            ">${totalSubjects}</span>
          </div>
        `);

      skillsContainer.append(allSkillsBtn);

      allSkillsBtn.on("click", function () {
        $(".skill-segment").css("fill", "");
        $("#users table").removeClass("hidden highlight-skill");
        $("#details-skills .skill-item").removeClass("active");
        
        if (isFiltered && orbitFlowerInstance) {
          orbitFlowerInstance.show(orbitFlowerInstance.reference);
          if (skillsFeature) {
            skillsFeature = new SkillsFeature($("svg"), orbitFlowerInstance.reference);
            skillsFeature.initialize();
          }
        } else {
          viz.show(currentorgmodel);
          if (skillsFeature) {
            skillsFeature = new SkillsFeature($("svg"), currentorgmodel);
            skillsFeature.initialize();
          }
        }
        $(".skill-gauge").addClass("hidden");
      });

      const skillMap = new Map();
      skills.each(function () {
        const skill = $(this);
        const skillId = skill.attr("id");
        skillMap.set(skillId, {
          element: skill,
          children: [],
          parents: [],
          hasSubjects: isFiltered ? referencedSkillIds.has(skillId) : true
        });
      });

      skillMap.forEach((skillData, id) => {
        const relations = skillData.element.find('relation[type="Child"]');
        relations.each(function () {
          const parentId = $(this).attr("id");
          if (skillMap.has(parentId)) {
            skillMap.get(parentId).children.push(id);
            skillData.parents.push(parentId);
          }
        });
      });

      // Function to check if a skill or any of its descendants have subjects (for filtered view)
      function hasSubjectsInHierarchy(skillId) {
        if (!isFiltered) return true; // In non-filtered view, show all skills
        
        const skillData = skillMap.get(skillId);
        if (!skillData) return false;
        
        // Check if this skill has subjects
        if (skillData.hasSubjects) return true;
        
        // Check if any children have subjects
        return skillData.children.some(childId => hasSubjectsInHierarchy(childId));
      }

      function renderSkill(skillId, level = 0) {
        const skillData = skillMap.get(skillId);
        if (!skillData) return;
        
        // Only render if this skill or its descendants have subjects (in filtered view)
        if (!hasSubjectsInHierarchy(skillId)) return;
        
        const color = window.getSkillIdColor(skillId);
        
        let subjectCount = 0;
        
        if (isFiltered) {
          // Count subjects with this skill in filtered view
          subjectCount = $(sourceModel).find(`subject subjectSkills ref[id="${skillId}"]`).length;
        } else {
          // Count subjects with this skill and all related skills (original behavior)
          const relatedSkills = getAllRelatedSkills(skillId);
          const uniqueSubjects = new Set();
          relatedSkills.forEach(relatedSkillId => {
            $(`subject subjectSkills ref[id="${relatedSkillId}"]`, sourceModel).each(function() {
              const subjectUid = $(this).closest('subject').attr('uid');
              if (subjectUid) {
                uniqueSubjects.add(subjectUid);
              }
            });
          });
          subjectCount = uniqueSubjects.size;
        }

        // Determine styling based on whether skill has subjects (for filtered view)
        const hasSubjects = isFiltered ? skillData.hasSubjects : true;
        const opacity = hasSubjects ? 1 : 0.5;
        const fontWeight = hasSubjects ? "500" : "400";
        const backgroundColor = hasSubjects ? "#f0f0f0" : "#f8f8f8";

        const skillElem = $(`
         <div class="skill-item" data-skill-id="${skillId}" 
               style="margin-left: ${level * 20}px; 
                     border-left: 3px solid ${color};
                     padding: 5px;
                     padding-right: 50px;
                     opacity: ${opacity};"
                     draggable="false">
           <span style="font-weight: ${fontWeight};">${skillId}</span>
           <span class="subject-count" style="
             font-size: 11px;
             color: ${isFiltered ? (hasSubjects ? '#666' : '#999') : '#666'};
             background: ${isFiltered ? backgroundColor : '#f0f0f0'};
             padding: 2px 6px;
             border-radius: 10px;
             min-width: 20px;
             text-align: center;
             font-weight: 500;
           ">${subjectCount}</span>
         </div>
         `);

        skillsContainer.append(skillElem);

        // Add drag functionality - use the same detailed implementation for both filtered and non-filtered views
        skillElem.on("pointerdown", function (e) {
          if (e.button !== 0) return; // Only left click
          e.preventDefault();
          let isDragging = false;
          let ghostBox = null;
          let startX = e.clientX;
          let startY = e.clientY;
          const DRAG_THRESH = 5;

          function moveHandler(ev) {
            const dx = ev.clientX - startX;
            const dy = ev.clientY - startY;
            if (!isDragging && Math.sqrt(dx * dx + dy * dy) > DRAG_THRESH) {
              isDragging = true;
              // Create ghost box
              ghostBox = document.createElement("div");
              ghostBox.id = "skill-drag-ghost";
              ghostBox.textContent = `Skill: ${skillId}`;
              Object.assign(ghostBox.style, {
                position: "fixed",
                left: `${ev.clientX}px`,
                top: `${ev.clientY}px`,
                padding: "8px 12px",
                backgroundColor: color,
                color: "#fff",
                borderRadius: "4px",
                fontFamily: "Arial, sans-serif",
                fontSize: "14px",
                fontWeight: "normal",
                pointerEvents: "none",
                zIndex: "9999",
                whiteSpace: "nowrap",
                boxShadow: "0 2px 6px rgba(0,0,0,0.2)",
                animation: "pulse 1s infinite",
                transform: "translate(-50%, -50%)"
              });
              document.body.appendChild(ghostBox);
              skillElem.addClass("dragging");
            }
            if (isDragging && ghostBox) {
              ghostBox.style.left = `${ev.clientX}px`;
              ghostBox.style.top = `${ev.clientY}px`;
              // Highlight expression blocks
              const expressionBlocks = document.querySelectorAll('.expr-block');
              let isOverBlock = false;
              expressionBlocks.forEach(block => {
                const rect = block.getBoundingClientRect();
                const isOver = ev.clientX >= rect.left &&
                  ev.clientX <= rect.right &&
                  ev.clientY >= rect.top &&
                  ev.clientY <= rect.bottom;
                if (isOver) {
                  isOverBlock = true;
                  block.classList.add('block-drop-target');
                  ghostBox.classList.add('over-expression');
                } else {
                  block.classList.remove('block-drop-target');
                }
              });
              // Highlight main expression display
              const exprDisplay = document.getElementById('currentExpression');
              if (exprDisplay) {
                const rect = exprDisplay.getBoundingClientRect();
                if (ev.clientX >= rect.left && ev.clientX <= rect.right && ev.clientY >= rect.top && ev.clientY <= rect.bottom) {
                  exprDisplay.classList.add('drop-target-active');
                } else {
                  exprDisplay.classList.remove('drop-target-active');
                }
              }
              if (!isOverBlock && ghostBox) {
                ghostBox.classList.remove('over-expression');
              }
            }
          }

          function upHandler(ev) {
            document.removeEventListener("pointermove", moveHandler);
            document.removeEventListener("pointerup", upHandler);
            document.removeEventListener("pointercancel", upHandler);
            if (ghostBox) ghostBox.remove();
            skillElem.removeClass("dragging");
            document.querySelectorAll('.block-drop-target').forEach(el => el.classList.remove('block-drop-target'));
            const exprDisplay = document.getElementById('currentExpression');
            if (exprDisplay) exprDisplay.classList.remove('drop-target-active');
            if (isDragging) {
              // Dispatch drop event
              window.dispatchEvent(new CustomEvent("skilldragend", {
                detail: {
                  skillId: skillId,
                  entityName: "",
                  entityType: "Skill",
                  pathId: skillId,
                  x: ev.clientX,
                  y: ev.clientY
                }
              }));
            }
          }

          document.addEventListener("pointermove", moveHandler);
          document.addEventListener("pointerup", upHandler);
          document.addEventListener("pointercancel", upHandler);
        });

        // Render children recursively
        skillData.children.forEach((childId) => {
          renderSkill(childId, level + 1);
        });
      }

      skillMap.forEach((skillData, id) => {
        if (skillData.parents.length === 0) {
          renderSkill(id);
        }
      });
    }
    // Add near the top of your script
    let isSplitView = false; 
    
    function setupSSEEventListeners() {
      const eventSource = new EventSource(
        `${serverlocation.replace(/\/$/, "")}/events/`
      );
      console.error("Listening for real-time updates...");

      eventSource.onopen = () => {
        console.error("SSE connection established");
        console.error("[SSE] Connection OPENED", new Date().toISOString());
      };
      eventSource.addEventListener("error", (e) => {
        console.error("[SSE] Error state:", e.eventPhase);
      });

      eventSource.addEventListener("update", (event) => {
        console.error("Update event received:", event.data);
        try {
          const updateData = JSON.parse(event.data);
          console.log("Update type:", updateData.type);

          $.ajax({
            url: serverlocation + "/organisation",
            success: function (res) {
              currentorgmodel = res;
              viz.show(currentorgmodel);

              if (skillsFeature) {
                skillsFeature = new SkillsFeature($("svg"), currentorgmodel);
                skillsFeature.initialize();
              }
            },
            error: function (err) {
              console.error(
                "Failed to load updated organization model:",
                err
              );
            },
          });
        } catch (error) {
          console.error("Error parsing update data:", error);
        }
      });

      eventSource.addEventListener("connected", (event) => {
        console.log("Connected to SSE stream:", event.data);
      });

      eventSource.onmessage = (event) => {
        console.log("Generic message received:", event.data);
        $.ajax({
          url: serverlocation + "/organisation",
          success: function (res) {
            currentorgmodel = res;
            viz.show(currentorgmodel);

            if (skillsFeature) {
              skillsFeature = new SkillsFeature($("svg"), currentorgmodel);
              skillsFeature.initialize();
            }
          },
          error: function (err) {
            console.error("Failed to load updated organization model:", err);
          },
        });
      };

      eventSource.onerror = (error) => {
        console.error("EventSource error:", error);
        setTimeout(() => {
          console.log("Attempting to reconnect to event stream...");
          eventSource.close();
          setupSSEEventListeners();
        }, 5000);
      };
    }

    $(document).ready(function () {
      $("svg").attr({
        width: "100%",
        height: "100%",
      });
      viz = new OrbitFlower($("svg"));

      $.ajax({
        url: "index.conf",
        dataType: "json",
        success: function (res) {
          serverlocation = res.server;
          $.ajax({
            url: serverlocation + "/organisation",
            success: function (res) {
              originalModel = res.cloneNode(true);
              currentorgmodel = res.cloneNode(true);
              fillSkillsContainer();
              getSkills("harapata97");
              viz.show(currentorgmodel);

              skillsFeature = new SkillsFeature($("svg"), currentorgmodel);
              skillsFeature.initialize();

              setupSSEEventListeners();
              initializeZooming();
            },
            error: function (err) {
              console.error("Failed to load organization model:", err);
            },
          });
        },
      });
      console.error("Server location:'''''''''''''''''''", serverlocation);

      const expressionBuilder = new ExpressionBuilder("expressionBuilder");
      window.expressionBuilderPaused = expressionBuilder.paused;

      // Listen for changes in the expression builder state
      document.addEventListener("expressionBuilder:change", function (event) {
        window.expressionBuilderPaused = event.detail.builder.paused;
      });

      let originalUserStates = [];
      var relatedSkills = [];
      let currentSkillFilter = null;
      let originalSkillStates = [];
      var unitId = null;
      var isZoomed = false;
      var originalModel = null;
      function storeOriginalUserStates() {
        originalUserStates = [];
        $("#users table").each(function () {
          originalUserStates.push({
            element: this,
            hidden: $(this).hasClass("hidden"),
          });
        });
      }

      function restoreOriginalUserStates() {
        originalUserStates.forEach((state) => {
          $(state.element).toggleClass("hidden", state.hidden);
        });
      }

      function storeOriginalSkillStates() {
        originalSkillStates = [];
        $("#details-skills .skill-item").each(function () {
          originalSkillStates.push({
            element: this,
            hidden: $(this).hasClass("hidden"),
          });
        });
      }
      function restoreOriginalSkillStates() {
        originalSkillStates.forEach((state) => {
          $(state.element).toggleClass("hidden", state.hidden);
        });
      }
      $("svg").on("click", ".skill-segment", function (e) {
        const skillSegment = $(this);
        const parentNode = skillSegment.closest("g").parent();
        const parentId = parentNode.attr("id");
        const unitId = document.querySelector(
          `text[id="${parentId}_text"]`
        )?.textContent;

        const skillId = skillSegment.attr("data-skill-id");
        const key = `${unitId}_${skillId}`;
        if (activeSkillSegments[key]) {
          delete activeSkillSegments[key];
          skillSegment.css("fill", "");

          if (Object.keys(activeSkillSegments).length === 0) {
            restoreOriginalUserStates();
          }
        } else {
          if (Object.keys(activeSkillSegments).length === 0) {
            storeOriginalUserStates();
          }

          activeSkillSegments = {};
          $(".skill-segment").css("fill", "");

          activeSkillSegments[key] = true;
          relatedSkills = getAllRelatedSkills(skillId);
          console.error("filtering by unitId", unitId);
          filterUsersByUnitAndSkill(unitId, relatedSkills);
          console.error("current selected users")
          skillSegment.css("fill", "#4CAF50");
        }

        $("#details-skills .skill-item").removeClass("active");
        relatedSkills.forEach((skillId) => {
          $(
            `#details-skills .skill-item[data-skill-id="${skillId}"]`
          ).addClass("active");
        });
      });

      function filterUsersByUnitAndSkill(unitId, skillIds) {
        const skillIdsArray = Array.isArray(skillIds) ? skillIds : [skillIds];
        $("#users table").each(function () {
          const $userRow = $(this);
          const userId = $userRow.attr("data-uid");
          const inUnit =
            $(
              `subject[uid="${userId}"] relation[unit="${unitId}"], subject[uid="${userId}"] relation[role="${unitId}"]`,
              currentorgmodel
            ).length > 0;
          let hasSkill = false;
          skillIdsArray.forEach((skillId) => {
            if (
              $(
                `subject[uid="${userId}"] subjectSkills ref[id="${skillId}"]`,
                currentorgmodel
              ).length > 0
            ) {
              hasSkill = true;
            }
          });
          $userRow
            .toggleClass("hidden", !(inUnit && hasSkill))
            .toggleClass("highlight-skill", inUnit && hasSkill);
        });
      }




      var control = true;
      var currentActiveSkill = null; // Track currently active skill

      $("#details-skills").on("mouseover", ".skill-item", function () {
        var targetSkillId = $(this).attr("data-skill-id");
        if (!targetSkillId) return;
        var relatedSkills = getAllRelatedSkills(targetSkillId);
        $("#main-svg")
          .find(".skill-segment")
          .each(function () {
            var skillSegment = $(this);
            var segmentSkillId = skillSegment.attr("data-skill-id");
            if (relatedSkills.includes(segmentSkillId)) {
              $(this).addClass("hover-highlight");
            } else {
              $(this).removeClass("hover-highlight");
            }
          });

        $("#testing-svg")
          .find("g.node")
          .each(function () {
            var node = $(this);
            var nodeId = node.attr("data-skill-id");
            if (relatedSkills.includes(nodeId)) {
              node.addClass("hover-highlight");
            } else {
              node.removeClass("hover-highlight");
            }

          });
      });

      $("#details-skills").on("mouseout", ".skill-item", function () {
        $("#main-svg").find(".skill-segment").removeClass("hover-highlight");
        $("#testing-svg").find("g.node").removeClass("hover-highlight");
      });

      $("#details-skills").on("click", function (e) {
        $("#details-skills .skill-item").removeClass("active");
        $("#details-skills .skill-item").removeClass("selected");
        var targetSkillId = e.target.getAttribute("data-skill-id");
        if (!targetSkillId || targetSkillId === currentActiveSkill) {
          expressionBuilder.highlightGraph();
          return;
        }


        var clonedModel = currentorgmodel.cloneNode(true);
        var allRelatedSkills = getAllRelatedSkills(targetSkillId);

        $(
          `#details-skills .skill-item[data-skill-id="${targetSkillId}"]`
        ).addClass("selected");
        allRelatedSkills.forEach((skillId) => {
          $(
            `#details-skills .skill-item[data-skill-id="${skillId}"]`
          ).addClass("active");
        });

        $(clonedModel)
          .find("subject")
          .each(function () {
            const subject = $(this);
            let hasSkill = false;
            for (const skillId of allRelatedSkills) {
              if (
                subject.find(`subjectSkills ref[id="${skillId}"]`).length > 0
              ) {
                hasSkill = true;
                break;
              }
            }
            if (!hasSkill) {
              subject.remove();
            }
          });

        $(clonedModel)
          .find("unit")
          .each(function () {
            const $unit = $(this);
            const unitId = $unit.attr("id");
            const used =
              $(clonedModel).find(`subject relation[unit="${unitId}"]`)
                .length > 0;
            if (!used) $unit.remove();
          });

        $(clonedModel)
          .find("role")
          .each(function () {
            const $role = $(this);
            const roleId = $role.attr("id");
            const used =
              $(clonedModel).find(`subject relation[role="${roleId}"]`)
                .length > 0;
            if (!used) $role.remove();
          });

        $("#users").empty();
        viz.show(clonedModel);
        skillsFeature = new SkillsFeature($("svg"), clonedModel);
        skillsFeature.initialize();
                                $(".skill-gauge").removeClass("hidden");

        updateSubjectGaugesForSkill(targetSkillId);
        expressionBuilder.highlightGraph()


      });

      // listened for dispatched event doubleclick
      window.addEventListener("nodedoubleclick", function (event) {
        console.error("I heard that there was a double click event");
        // Update expression builder to work with current filtered view
        expressionBuilder.highlightGraph();
        
        // Update gauges for filtered view if needed
        const filteredUsers = $("#users table:visible");
        if (filteredUsers.length > 0) {
          console.log("Updated view with", filteredUsers.length, "filtered users");
        }
      });
          let lastClickedSkill = null;
    let isFiltered = false;
     $(document).on("click", "#detailed-graph-skills", function (e) {
      let target = e.target;
      // If the target is a circle, use its parent (the group) as the target
      if (target.tagName === "circle") {
        target = target.parentNode;
      }
      if (!target) {
        return;
      }
      
      const skillId = target.getAttribute("data-skill-id");
      
      // Toggle filter when same skill is clicked again
      if (skillId === lastClickedSkill && isFiltered) {
        // Restore all users
        $("#users table").removeClass("hidden");
        isFiltered = false;
        return;
      }
      
      // Filter users column by skillId
      if (skillId) {
        $("#users table").each(function () {
          const $userRow = $(this);
          const userId = $userRow.attr("data-uid");
          const hasSkill = $(
            `subject[uid="${userId}"] subjectSkills ref[id="${skillId}"]`,
            currentorgmodel
          ).length > 0;
          $userRow.toggleClass("hidden", !hasSkill);
        });
        
        // Update state
        lastClickedSkill = skillId;
        isFiltered = true;
      } else {
        // Restore all users when clicking outside skills
        $("#users table").removeClass("hidden");
        lastClickedSkill = null;
        isFiltered = false;
      }
    });


      $("svg").on("click", function (e) {
        var clickedElement = e.target;
        if (clickedElement.tagName === "circle") {
          if ( _isolationState.isIsolated) {
            // If isolation is active, do not toggle visibility
            return;
          }
          if (!clickedElement.hasAttribute("data-is-active")) {
            $("#users")
              .find("table")
              .each(function () {
                if (!$(this).hasClass("highlightrole")) {
                  $(this).addClass("hidden");
                }
                if ($(this).hasClass("highlightunit")) {
                  $(this).removeClass("hidden");
                }
              });
            clickedElement.setAttribute("data-is-active", "true");
          } else {
            $("#users")
              .find("table")
              .each(function () {
                $(this).removeClass("hidden");
              });
            clickedElement.removeAttribute("data-is-active");
          }
        }
        if (
          clickedElement.classList.contains("skill-segment") && !isSplitting &&
          clickedElement.tagName === "path"
        ) {
          var parentNodeId =
            clickedElement.parentNode.parentNode.getAttribute("id");
          parentNodeType =
            clickedElement.parentNode.parentNode.getAttribute("class");
          if (!isZoomed) {
            relatedText =
              document.querySelector(`text[id="${parentNodeId}_text"]`)
                ?.textContent || "";
          }
          const skillId = clickedElement.getAttribute("data-skill-id");
          options = {
            container: "detailed-graph-skills",
          };
          const workerGraph = new SkillTreeComponent(options);
          workerGraph.reset("#detailed-graph-skills");
          workerGraph.show(
            currentorgmodel,
            parentNodeType,
            relatedText,
            skillId
          );
          isZoomed = true;
        }
        if (clickedElement.classList.contains("node")) {
          const skillId = clickedElement.getAttribute("data-skill-id");
          const parentNode = clickedElement.closest("g.node");
          console.error("parentNode", parentNode);
        }
        console.error("Clicked element:", clickedElement);
      });
    });
    function updateSubjectGaugesForSkill(skillId) {
      $("#users table").each(function () {
        const $userRow = $(this);
        const userId = $userRow.attr("data-uid");
        const $ref = $(currentorgmodel)
          .find(`subject[uid='${userId}'] ref[id='${skillId}']`);

        let normalized = 0;
        if ($ref.length) {
          const strength = parseFloat($ref.attr("strength") || "0");
          if (!isNaN(strength)) {
            normalized = strength > 1 ? Math.min(1, strength / 100) : Math.min(1, strength);
          }
        }

        const pct = Math.round(normalized * 100);
        const $gauge = $userRow.find(".gauge-bar");
        if (!$gauge.length) return;

        $gauge
          .attr("data-level", normalized)
          .css({
            width: pct + "%",
            background: normalized > 0 ? "#4CAF50" : "#eee"
          })
          .attr("title", pct + "%");
      });
    }

  </script>
</head>

<body is="x-ui-">
  <ui-rest id="main">


    <ui-tabbar>
      <ui-before></ui-before>
      <ui-tab class="default" data-tab="graph">Home</ui-tab>
      <ui-tab class="inactive" data-tab="manage-subjects">Add Subject</ui-tab>
      <ui-tab class="inactive" data-tab="manage-units">Add Unit</ui-tab>
      <ui-tab class="inactive" data-tab="manage-roles">Add Role</ui-tab>
      <ui-tab class="inactive" data-tab="manage-skills">Add Skill</ui-tab>
      <ui-behind></ui-behind>
      <ui-last></ui-last>
    </ui-tabbar>
    <ui-content class="noselect">
      <ui-area data-belongs-to-tab="graph" style="border-right: 1px solid var(--x-ui-border-color)">
        <div class="x-ui-layout tab-content" id="graph" style="height: 100%; min-height: 500px">
          <svg style="width: 100%; height: 100%"></svg>
        </div>
      </ui-area>
      <ui-resizehandle data-belongs-to-tab="graph" data-label="drag to resize"></ui-resizehandle>
      <ui-area is="x-ui-" data-belongs-to-tab="graph"
        style="border-right: 1px solid var(--x-ui-border-color); height: 100%">
        <div id="users-container" style="
              display: flex;
              flex-direction: row;
              min-height: 200px;
              border-bottom: 1px solid var(--x-ui-border-color);
            ">
          <div id="users" style="flex: 1; overflow: auto; margin-left: 20px"></div>
          <div id="details-skills" style="flex: 1; overflow: auto; padding-left: 10px"></div>
        </div>
        <ui-resizehandle>drag to resize</ui-resizehandle>
        <div id="expressionBuilder" style="flex: 1; min-height: 200px; overflow: auto"></div>
      </ui-area>
      <ui-area data-belongs-to-tab="manage-subjects" class="inactive">
        <div class="subjects-management-container">
          <div class="subjects-list-section">
            <h3>Current Subjects</h3>
            <div class="subjects-filter">
              <input type="text" id="subjects-search" placeholder="Search subjects..." />
            </div>
            <div id="subjects-list" class="subjects-list">
              <!-- Subjects will be loaded here -->
            </div>
          </div>
          
          <div class="subject-editor-section">
            <h3 id="subject-editor-title">Add New Subject</h3>
            <form id="manage-subjects-form" class="manage-form">
              <div class="form-group">
                <label for="subject-id">Subject ID:</label>
                <input type="text" id="subject-id" placeholder="Subject ID" required />
              </div>
              
              <div class="relations-section">
                <h4>Unit-Role Relations</h4>
                <div id="unit-role-pairs">
                  <!-- Unit-role pairs will be added here -->
                </div>
                <div class="add-relation-controls">
                  <input type="text" id="unit-id-input" placeholder="Unit ID" />
                  <input type="text" id="role-id-input" placeholder="Role ID" />
                  <button type="button" id="add-unit-role-btn" onclick="window.addUnitRolePair()">Add Pair</button>
                </div>
              </div>
              
              <div class="form-actions">
                <button type="submit" id="subject-submit-btn">Add Subject</button>
                <button type="button" id="cancel-subject-btn" style="display: none;">Cancel</button>
              </div>
              <div id="messages-subjects"></div>
            </form>
          </div>
        </div>
      </ui-area>
      <ui-area data-belongs-to-tab="manage-units" class="inactive">
        <div class="units-management-container">
          <div class="units-list-section">
            <h3>Current Units</h3>
            <div class="units-filter">
              <input type="text" id="units-search" placeholder="Search units..." />
            </div>
            <div id="units-list" class="units-list">
              <!-- Units will be loaded here -->
            </div>
          </div>
          
          <div class="unit-editor-section">
            <h3 id="unit-editor-title">Add New Unit</h3>
            <form id="manage-units-form" class="manage-form">
              <div class="form-group">
                <label for="unit-id">Unit ID:</label>
                <input type="text" id="unit-id" placeholder="Unit ID" required />
              </div>
              <div class="form-group">
                <label for="unit-parent-id">Parent ID:</label>
                <input type="text" id="unit-parent-id" placeholder="Parent ID (optional)" />
              </div>
              
              <div class="form-actions">
                <button type="submit" id="unit-submit-btn">Add Unit</button>
                <button type="button" id="cancel-unit-btn" style="display: none;">Cancel</button>
              </div>
              <div id="messages-units"></div>
            </form>
          </div>
        </div>
      </ui-area>
      <ui-area data-belongs-to-tab="manage-roles" class="inactive">
        <div class="roles-management-container">
          <div class="roles-list-section">
            <h3>Current Roles</h3>
            <div class="roles-filter">
              <input type="text" id="roles-search" placeholder="Search roles..." />
            </div>
            <div id="roles-list" class="roles-list">
              <!-- Roles will be loaded here -->
            </div>
          </div>
          
          <div class="role-editor-section">
            <h3 id="role-editor-title">Add New Role</h3>
            <form id="manage-roles-form" class="manage-form">
              <div class="form-group">
                <label for="role-id">Role ID:</label>
                <input type="text" id="role-id" placeholder="Role ID" required />
              </div>
              
              <div class="relations-section">
                <h4>Parent Roles</h4>
                <div id="role-parents">
                  <!-- Role parents will be added here -->
                </div>
                <div class="add-relation-controls">
                  <input type="text" id="parent-role-input" placeholder="Parent Role ID" />
                  <button type="button" id="add-role-parent-btn">Add Parent</button>
                </div>
              </div>
              
              <div class="form-actions">
                <button type="submit" id="role-submit-btn">Add Role</button>
                <button type="button" id="cancel-role-btn" style="display: none;">Cancel</button>
              </div>
              <div id="messages-roles"></div>
            </form>
          </div>
        </div>
      </ui-area>
      <ui-area data-belongs-to-tab="manage-skills" class="inactive">
        <div class="tab-content" id="manage-skills">
          <!-- Skills List Section -->
          <div class="skills-management-container">
            <div class="skills-list-section">
              <h3>Current Skills</h3>
              <div class="skills-filter">
                <input type="text" id="skills-search" placeholder="Search skills..." />
              </div>
              <div id="skills-list" class="skills-list">
                <!-- Skills will be loaded here -->
              </div>
            </div>
            
            <!-- Skill Editor Section -->
            <div class="skill-editor-section">
              <h3 id="skill-editor-title">Add New Skill</h3>
              <form id="manage-skills-form" class="manage-form">
                <div class="form-group">
                  <label for="skill-id">Skill ID:</label>
                  <input type="text" id="skill-id" placeholder="Skill ID" required="" />
                </div>
                
                <div class="relations-section">
                  <h4>Skill Relations</h4>
                  <div id="relations-container">
                    <!-- Relations will be added here -->
                  </div>
                  <div class="add-relation-controls">
                    <select id="available-skills-dropdown" class="skill-dropdown">
                      <option value="">Select a skill to relate...</option>
                    </select>
                    <button type="button" id="add-relation-btn">Add Relation</button>
                    <button type="button" id="add-manual-relation-btn">Add Manual</button>
                  </div>
                </div>
                
                <div class="form-actions">
                  <button type="submit" id="skill-submit-btn">Add Skill</button>
                  <button type="button" id="cancel-edit-btn" style="display: none;">Cancel</button>
                </div>
                <div id="messages-skills"></div>
              </form>
            </div>
          </div>
        </div>
      </ui-area>
    </ui-content>
  </ui-rest>
</body>

</html>